<form class="sheet actor exacom-sheet" autocomplete="off">
  <header class="exacom-header">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="120" width="120" />
    <div class="header-fields">
      <div class="exacom-name-line">
        <div class="name-field">
          <label>Nome</label>
          <input type="text" name="name" value="{{actor.name}}" placeholder="Nome do EXAcom" />
        </div>
        <div class="field">
          <label>Escala</label>
          <input type="text" name="system.identificacao.escala" value="Grande" readonly />
        </div>
      </div>
      <div class="exacom-info-grid">
        <div class="field">
          <label>Piloto</label>
          <div class="linked-input">
            <input type="text" name="system.identificacao.piloto" value="{{system.identificacao.piloto}}" placeholder="Nome do piloto" {{#if linkedPilot}}readonly{{/if}} />
            <button type="button" class="open-linked-pilot" {{#unless linkedPilot}}disabled{{/unless}}>Abrir Piloto</button>
          </div>
        </div>
        <div class="field">
          <label>Categoria</label>
          <input type="text" name="system.identificacao.categoria" value="{{system.identificacao.categoria}}" />
        </div>
        <div class="field">
          <label>Modelo</label>
          <select name="system.modeloId" data-dtype="String">
            <option value="">-- Selecione --</option>
            {{#each exacomModels}}
            <option value="{{this.id}}" {{#if (eq ../system.modeloId this.id)}}selected{{/if}}>{{this.name}}</option>
            {{/each}}
          </select>
        </div>
        <div class="field">
          <label>MCE</label>
          <input type="text" name="system.identificacao.mce" value="{{system.identificacao.mce}}" />
        </div>
        <div class="field">
          <label>Admiss√£o</label>
          <input type="text" name="system.identificacao.admissao" value="{{system.identificacao.admissao}}" />
        </div>
      </div>
    </div>
  </header>

  <nav class="exacom-tabs tabs" data-group="exacom">
    <a class="item" data-tab="sistema">Sistema</a>
    <a class="item" data-tab="exa">EXA</a>
  </nav>

  <section class="exacom-body">
    <div class="tab" data-group="exacom" data-tab="sistema">
      <div class="exacom-sections">
        <div class="card sistema-card">
          <h3>Sistema</h3>
          <div class="sistema-grid">
            <!-- Linha 1: Labels -->
            <div class="sistema-label">Neuromotor</div>
            <div class="sistema-label">Sensorial</div>
            <div class="sistema-label">Estrutural</div>
            <div class="sistema-label">Reator</div>
            
            <!-- Linha 2: Valores Base (edit√°veis) -->
            <div class="sistema-value">
              <input type="number" name="system.sistema.neuromotor" value="{{number system.sistema.neuromotor}}" data-dtype="Number" min="0" />
              <small style="display: block; font-size: 0.7rem; color: #666; margin-top: 2px;">Efetivo: <strong>{{number sistemaEfetivo.neuromotor}}</strong></small>
            </div>
            <div class="sistema-value">
              <input type="number" name="system.sistema.sensorial" value="{{number system.sistema.sensorial}}" data-dtype="Number" min="0" />
              <small style="display: block; font-size: 0.7rem; color: #666; margin-top: 2px;">Efetivo: <strong>{{number sistemaEfetivo.sensorial}}</strong></small>
            </div>
            <div class="sistema-value">
              <input type="number" name="system.sistema.estrutural" value="{{number system.sistema.estrutural}}" data-dtype="Number" min="0" />
              <small style="display: block; font-size: 0.7rem; color: #666; margin-top: 2px;">Efetivo: <strong>{{number sistemaEfetivo.estrutural}}</strong></small>
            </div>
            <div class="sistema-value">
              <input type="number" name="system.sistema.energetico" value="{{number system.sistema.energetico}}" data-dtype="Number" min="0" />
              <small style="display: block; font-size: 0.7rem; color: #666; margin-top: 2px;">Efetivo: <strong>{{number sistemaEfetivo.energetico}}</strong></small>
            </div>
            
            <!-- Linha 3: Bot√µes de rolagem -->
            <div class="sistema-roll">
              <button type="button" class="roll-atributo-sistema" data-atributo="sistema.neuromotor" data-label="Neuromotor" title="Rolar Neuromotor">üé≤</button>
            </div>
            <div class="sistema-roll">
              <button type="button" class="roll-atributo-sistema" data-atributo="sistema.sensorial" data-label="Sensorial" title="Rolar Sensorial">üé≤</button>
            </div>
            <div class="sistema-roll">
              <button type="button" class="roll-atributo-sistema" data-atributo="sistema.estrutural" data-label="Estrutural" title="Rolar Estrutural">üé≤</button>
            </div>
            <div class="sistema-roll">
              <button type="button" class="roll-atributo-sistema" data-atributo="sistema.energetico" data-label="Reator" title="Rolar Reator">üé≤</button>
            </div>
            
            <!-- Linha 4: Penalidades -->
            <div class="sistema-penalidade">
              <label>Penalidade:</label>
              <input type="number" name="system.sistema.penalidades.neuromotor" value="{{number system.sistema.penalidades.neuromotor}}" min="0" data-dtype="Number" />
            </div>
            <div class="sistema-penalidade">
              <label>Penalidade:</label>
              <input type="number" name="system.sistema.penalidades.sensorial" value="{{number system.sistema.penalidades.sensorial}}" min="0" data-dtype="Number" />
            </div>
            <div class="sistema-penalidade">
              <label>Penalidade:</label>
              <input type="number" name="system.sistema.penalidades.estrutural" value="{{number system.sistema.penalidades.estrutural}}" min="0" data-dtype="Number" />
            </div>
            <div class="sistema-penalidade">
              <label>Penalidade:</label>
              <input type="number" name="system.sistema.penalidades.energetico" value="{{number system.sistema.penalidades.energetico}}" min="0" data-dtype="Number" />
            </div>
          </div>
        </div>

        {{#if capacity}}
        <div class="exacom-capacity-meter">
          <div class="exacom-capacity-meter__header">
            <span>Capacidade</span>
            <span>{{number capacity.total}} / {{number capacity.max}} kg</span>
          </div>
          <div class="exacom-capacity-meter__bar">
            <div class="exacom-capacity-meter__fill {{#if capacity.overLimit}}is-over{{/if}}" style="width: {{capacity.percent}}%; background-color: {{capacity.color}};"></div>
          </div>
          <div class="exacom-capacity-meter__status {{#if capacity.overLimit}}alert{{/if}}">
            {{capacity.statusLabel}}
          </div>
        </div>
        {{/if}}

        <div class="card combate-card">
          <h3>Atributos de Combate</h3>
          <div class="dual-grid">
            <div class="field">
              <label>Iniciativa:</label>
              <input type="number" name="system.combate.iniciativa" value="{{calculatedIniciativa}}" readonly />
              <button type="button" class="roll-iniciativa" title="Rolar Iniciativa">üé≤</button>
            </div>
            <div class="field">
              <label>Esquiva</label>
              <input type="number" name="system.combate.esquiva" value="{{calculatedEsquiva}}" readonly />
            </div>
            <div class="field">
              <label>Mobilidade</label>
              <input type="number" name="system.combate.mobilidade" value="{{calculatedMobilidade}}" readonly />
            </div>
          </div>
        </div>

        <div class="card limiar-section">
          <h3>Limiar de Dano</h3>
          <table class="limiar-table">
            <thead>
              <tr>
                <th></th>
                <th>Leve</th>
                <th>M√©dio</th>
                <th>Grave</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>Limiar</th>
                <td><input type="number" name="system.limiarDano.leve.limiar" value="{{limiarLeve}}" readonly /></td>
                <td><input type="number" name="system.limiarDano.moderado.limiar" value="{{limiarMedio}}" readonly /></td>
                <td><input type="number" name="system.limiarDano.grave.limiar" value="{{limiarGrave}}" readonly /></td>
              </tr>
              <tr>
                <th>Marca√ß√µes</th>
                <td><input type="number" name="system.limiarDano.leve.marcacoes" value="{{number system.limiarDano.leve.marcacoes}}" min="0" max="3" data-dtype="Number" /></td>
                <td><input type="number" name="system.limiarDano.moderado.marcacoes" value="{{number system.limiarDano.moderado.marcacoes}}" min="0" max="3" data-dtype="Number" /></td>
                <td><input type="number" name="system.limiarDano.grave.marcacoes" value="{{number system.limiarDano.grave.marcacoes}}" min="0" max="1" data-dtype="Number" /></td>
              </tr>
            </tbody>
          </table>
          <div class="penalidades">
            <label>Penalidades</label>
            <input type="number" name="system.limiarDano.penalidades" value="{{number system.limiarDano.penalidades}}" min="0" data-dtype="Number" />
          </div>
        </div>

        <div class="card equipamentos-card">
          <h3>Equipamentos</h3>

          <section class="equipamento-bloco">
            <div class="attack-header">
              <h4>Armas</h4>
              <button type="button" class="arma-create">+ Adicionar Arma</button>
            </div>
            <table class="attack-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Atributo</th>
                  <th>Dado Base</th>
                  <th>Alcance</th>
                  <th>Dano</th>
                  <th>Efeito</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {{#if armasList.length}}
                  {{#each armasList}}
                  <tr>
                    <td>{{this.nome}}</td>
                    <td>{{this.atributoLabel}}</td>
                    <td>{{this.dadoBase}}</td>
                    <td>{{this.alcance}}</td>
                    <td>{{this.dano}}</td>
                    <td>{{this.efeito}}</td>
                    <td class="attack-actions">
                      <button type="button" class="arma-roll" data-index="{{this.index}}" title="Rolar">üé≤</button>
                      <button type="button" class="arma-edit" data-index="{{this.index}}" title="Editar">‚úèÔ∏è</button>
                      <button type="button" class="arma-delete" data-index="{{this.index}}" title="Excluir">üóëÔ∏è</button>
                    </td>
                  </tr>
                  {{/each}}
                {{else}}
                  <tr>
                    <td colspan="7" class="empty-row">Nenhuma arma cadastrada.</td>
                  </tr>
                {{/if}}
              </tbody>
            </table>
          </section>

          <section class="equipamento-bloco">
            <header>
              <h4>Blindagem</h4>
            </header>
            <div class="field">
              <label>Blindagem Equipada:</label>
              <select name="system.equipamentosExa.blindagemId" data-dtype="String" class="item-select-blindagem">
                <option value="">-- Nenhuma --</option>
                {{#each blindagensExacom}}
                <option value="{{this.id}}" {{#if (eq ../system.equipamentosExa.blindagemId this.id)}}selected{{/if}}>
                  {{this.name}} (Blindagem: {{this.system.blindagem}})
                </option>
                {{/each}}
              </select>
            </div>
            {{#if selectedBlindagem}}
            <div class="field">
              <label>Valor da Blindagem:</label>
              <input type="number" name="system.equipamentosExa.blindagem" value="{{selectedBlindagem.system.blindagem}}" readonly />
            </div>
            <div class="field">
              <label>Especial:</label>
              <textarea name="system.equipamentosExa.blindagemEspecial" readonly rows="2">{{selectedBlindagem.system.especial}}</textarea>
            </div>
            {{else}}
            <div class="field">
              <label>Valor da Blindagem:</label>
              <input type="number" name="system.equipamentosExa.blindagem" value="0" readonly />
            </div>
            <div class="field">
              <label>Especial:</label>
              <textarea name="system.equipamentosExa.blindagemEspecial" readonly rows="2">‚Äî</textarea>
            </div>
            {{/if}}
          </section>
        </div>
      </div>
    </div>

    <div class="tab" data-group="exacom" data-tab="exa">
      <div class="card exa-card">
        <header class="exa-card-header">
          <h3>EXAlink</h3>
        </header>
        <div class="dual-grid">
          <div class="field">
            <label>Sincronia</label>
            <input type="number" name="system.exa.sincronia" value="{{number system.exa.sincronia}}" data-dtype="Number" min="0" />
            <button type="button" class="roll-sincronia" title="Rolar Sincronia">üé≤</button>
          </div>
          <div class="field">
            <label>Overdrive</label>
            <input type="number" name="system.exa.overdrive" value="{{linkedPilotOverdrive}}" readonly />
            <small>{{#if linkedPilot}}Do Piloto ({{linkedPilot.name}}){{else}}Sem piloto vinculado{{/if}}</small>
          </div>
        </div>
      </div>

      <div class="card exa-mods-card">
        <h3>EXAmods</h3>

        <section class="equipamento-bloco">
          <header>
            <h4>Reator</h4>
          </header>
          <div class="reator-display">
            {{#if selectedModelReator}}
              <strong>{{selectedModelReator}}</strong>
            {{else}}
              <span class="empty-value">‚Äî</span>
            {{/if}}
          </div>
        </section>

        <section class="equipamento-bloco">
          <header>
            <h4>M√≥dulos EXA</h4>
            <div style="font-size: 0.9em; color: #666; margin-top: 4px;">
              <strong>Consumo Total: {{totalConsumoEquipado}} / {{reatorDisponivel}}</strong>
              {{#if modulosDisponiveis}}
                <span style="color: #4a9;">‚úì Espa√ßo dispon√≠vel</span>
              {{else}}
                <span style="color: #a44;">‚ö† Limite atingido</span>
              {{/if}}
            </div>
          </header>
          
          <div style="margin-bottom: 8px;">
            <a class="item-control modulo-create" 
               title="Adicionar Novo M√≥dulo"
               style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: rgba(0, 0, 0, 0.1); border-radius: 3px; text-decoration: none;">
              <i class="fas fa-plus"></i>
              Adicionar M√≥dulo
            </a>
          </div>
          
          <ol class="items-list">
            {{#if modulosOrdenados.length}}
              {{#each modulosOrdenados as |modulo id|}}
              <li class="item flexrow" 
                  data-item-id="{{modulo._id}}">
                <div class="item-name flexrow">
                  <div class="item-image">
                    <img src="{{modulo.img}}" title="{{modulo.name}}" 
                         width="24" height="24" />
                  </div>
                  <h4>{{modulo.name}}</h4>
                </div>
                <div class="item-details" style="flex: 1; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                  <span style="display: inline-block; padding: 2px 6px; background: rgba(0, 0, 0, 0.1); border-radius: 3px; font-size: 0.85em; font-weight: bold;">Consumo: {{modulo.system.consumo}}</span>
                  {{#if modulo.system.custo}}
                  <span style="display: inline-block; padding: 2px 6px; background: rgba(0, 0, 0, 0.1); border-radius: 3px; font-size: 0.85em;">Custo: {{modulo.system.custo}}d6</span>
                  {{/if}}
                  {{#if modulo.system.tipo}}
                  <span style="display: inline-block; padding: 2px 6px; background: rgba(0, 0, 0, 0.1); border-radius: 3px; font-size: 0.85em;">{{modulo.system.tipo}}</span>
                  {{/if}}
                </div>
                <div class="item-controls">
                  <a class="item-control modulo-use" 
                     title="Ativar/Usar M√≥dulo"
                     data-item-id="{{modulo._id}}">
                    <i class="fas fa-dice"></i>
                  </a>
                  <a class="item-control item-edit" 
                     title="Editar M√≥dulo">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a class="item-control item-delete" 
                     title="Deletar M√≥dulo">
                    <i class="fas fa-trash"></i>
                  </a>
                </div>
              </li>
              {{/each}}
            {{else}}
              <li class="item flexrow">
                <div class="item-name">
                  <em>Nenhum m√≥dulo equipado.</em>
                </div>
              </li>
            {{/if}}
          </ol>
        </section>
      </div>
    </div>
  </section>
</form>

